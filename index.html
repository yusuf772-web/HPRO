<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Kalender HPRO</title>
    
    <!-- PWA (Progressive Web App) Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Kalender HPRO">
    <meta name="theme-color" content="#2563eb">
    <link rel="manifest" href="manifest.json">
    <!-- Updated Icon -->
    <link rel="apple-touch-icon" href="https://instagram.fcgk42-1.fna.fbcdn.net/v/t51.2885-19/349035095_6380478465372384_4538678837004863365_n.jpg?stp=dst-jpg_s150x150_tt6&_nc_ht=instagram.fcgk42-1.fna.fbcdn.net&_nc_cat=100&_nc_oc=Q6cZ2QEEXF3WTemPkv2z_EomujqrrjKyq4mZbpWkDz7VvQp-pcfWcUTtE3VHV-f9-oTEakQ&_nc_ohc=e7UjKU7tTzYQ7kNvwFyZsrO&_nc_gid=q6BCKkGdodvJrIhHmWLYZQ&edm=AP4sbd4BAAAA&ccb=7-5&oh=00_AfSCYi21_EN2MNg3FNqC5AFQ9uncDneHwLRt_MYzFF3SlA&oe=68759C8C&_nc_sid=7a9f4b">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }
        .calendar-day {
            transition: all 0.2s ease-in-out;
        }
        .event-dot {
            width: 5px;
            height: 5px;
            border-radius: 50%;
        }
        .modal-backdrop {
            background-color: rgba(15, 23, 42, 0.5);
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .modal.hidden {
            pointer-events: none;
        }
        .modal.hidden .modal-backdrop {
            opacity: 0;
        }
        .modal.hidden .modal-content {
            transform: scale(0.95) translateY(10px);
            opacity: 0;
        }
        button:disabled {
            background-color: #94a3b8;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .filter-btn {
            color: #475569;
            background-color: transparent;
            transition: all 0.2s ease-in-out;
        }
        .filter-btn.active {
            background-color: white;
            color: #1e293b;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .custom-checkbox {
            -webkit-appearance: none;
            appearance: none;
            background-color: #fff;
            margin: 0;
            font: inherit;
            color: currentColor;
            width: 1.25em;
            height: 1.25em;
            border: 0.15em solid #cbd5e1;
            border-radius: 0.25rem;
            transform: translateY(-0.075em);
            display: grid;
            place-content: center;
            cursor: pointer;
            transition: all 0.1s ease-in-out;
        }
        .custom-checkbox::before {
            content: "";
            width: 0.65em;
            height: 0.65em;
            transform: scale(0);
            transition: 120ms transform ease-in-out;
            box-shadow: inset 1em 1em #2563eb;
            transform-origin: bottom left;
            clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
        }
        .custom-checkbox:checked::before {
            transform: scale(1);
        }
        .custom-checkbox:checked {
            background-color: #2563eb;
            border-color: #2563eb;
        }
    </style>
</head>
<body class="text-slate-800">

    <div id="app-view" class="container mx-auto p-4 md:p-8 max-w-7xl">
        <h1 class="text-3xl font-bold text-slate-900 mb-6 text-center">Kalender HPRO</h1>

        <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
            <div class="lg:col-span-3">
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <div class="flex items-center justify-between mb-4">
                        <button id="prev-month" class="p-2 rounded-full hover:bg-slate-100 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
                        <h2 id="month-year" class="text-xl font-semibold text-slate-700"></h2>
                        <button id="next-month" class="p-2 rounded-full hover:bg-slate-100 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></button>
                    </div>
                    <div class="calendar-grid text-center font-medium text-sm text-slate-500 mb-2">
                        <div>Min</div><div>Sen</div><div>Sel</div><div>Rab</div><div>Kam</div><div>Jum</div><div>Sab</div>
                    </div>
                    <div id="calendar-dates" class="calendar-grid"></div>
                </div>
                <div class="mt-4 space-y-4 sm:space-y-0 sm:flex sm:flex-row sm:gap-3 sm:items-center">
                    <button id="open-add-modal-btn" class="w-full sm:w-auto bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors shadow-md flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                        Tambah Jadwal
                     </button>
                     <div class="flex-grow flex items-center justify-center sm:justify-start">
                        <div class="bg-slate-200 rounded-lg p-1 flex items-center gap-1 w-full sm:w-auto">
                            <button id="filter-all" class="filter-btn active w-full px-4 py-1.5 text-sm font-semibold rounded-md">Semua</button>
                            <button id="filter-not-done" class="filter-btn w-full px-4 py-1.5 text-sm font-semibold rounded-md">Belum Dikerjakan</button>
                            <button id="filter-done" class="filter-btn w-full px-4 py-1.5 text-sm font-semibold rounded-md">Selesai</button>
                        </div>
                     </div>
                </div>
            </div>

            <div class="lg:col-span-2">
                 <h3 class="text-2xl font-bold text-slate-900 mb-4">Jadwal untuk <span id="selected-date-display" class="text-blue-600"></span></h3>
                 <div class="bg-white p-2 rounded-xl shadow-lg min-h-[50vh] lg:max-h-[70vh] overflow-y-auto">
                    <div id="event-list" class="space-y-2"></div>
                 </div>
            </div>
        </div>
    </div>

    <!-- Modal Base -->
    <div id="modal-template" class="modal fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="modal-content bg-white rounded-xl shadow-2xl p-6 w-full max-w-md m-4 relative"></div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast-notification" class="fixed bottom-5 right-5 bg-slate-800 text-white py-3 px-5 rounded-lg shadow-lg flex items-center gap-3 transform translate-y-20 opacity-0 transition-all duration-300 ease-out z-50">
        <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
        <p id="toast-message"></p>
        <button id="close-toast" class="text-slate-400 hover:text-white text-2xl leading-none">&times;</button>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc, deleteDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = {
          apiKey: "AIzaSyDXvjgL9dY_rBg6bcq7bvf6K1yVgCGnr9U",
          authDomain: "hpro-c1ec0.firebaseapp.com",
          projectId: "hpro-c1ec0",
          storageBucket: "hpro-c1ec0.appspot.com",
          messagingSenderId: "914516972845",
          appId: "1:914516972845:web:0a4ef1b18559f28e866fa4"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let selectedDate = new Date();
        let events = [];
        let currentFilter = 'all'; 
        let unsubscribe;
        let notificationShown = false;

        const categoryColors = {
            konten: 'border-blue-500',
            agenda: 'border-purple-500',
            flayer: 'border-orange-500',
            default: 'border-gray-500'
        };
        const categoryColorsBG = {
            konten: 'bg-blue-500',
            agenda: 'bg-purple-500',
            flayer: 'bg-orange-500',
            default: 'bg-gray-500'
        };
        const categoryNames = {
            konten: 'Konten',
            agenda: 'Agenda',
            flayer: 'Flayer (Hari Penting)'
        };
        
        function getFormFieldsHTML(category, prefix = '') {
            switch (category) {
                case 'konten':
                    return `
                        <div class="space-y-3">
                            <input type="text" id="${prefix}event-title" placeholder="Nama Konten" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <input type="url" id="${prefix}event-link" placeholder="https://contoh.com" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <textarea id="${prefix}event-note" placeholder="Note..." class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500" rows="2"></textarea>
                        </div>
                    `;
                case 'agenda':
                    return `
                        <div class="space-y-3">
                            <input type="text" id="${prefix}event-title" placeholder="Nama Kegiatan" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <input type="time" id="${prefix}event-time" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    `;
                case 'flayer':
                    return `
                        <input type="text" id="${prefix}event-title" placeholder="Nama Kegiatan" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    `;
                default:
                    return '';
            }
        }

        function switchFormField(container, category, prefix = '') {
            container.innerHTML = getFormFieldsHTML(category, prefix);
        }

        function getDotColorForDate(dateString) {
            const eventsOnDay = events.filter(event => event.date === dateString);
            if (eventsOnDay.length === 0) return '';
            
            if (eventsOnDay.some(e => e.category === 'flayer')) return categoryColorsBG.flayer;
            if (eventsOnDay.some(e => e.category === 'agenda')) return categoryColorsBG.agenda;
            if (eventsOnDay.some(e => e.category === 'konten')) return categoryColorsBG.konten;
            return categoryColorsBG.default;
        }

        function renderCalendar() {
            const calendarDatesEl = document.getElementById('calendar-dates');
            const monthYearEl = document.getElementById('month-year');
            calendarDatesEl.innerHTML = '';
            const firstDayOfMonth = new Date(currentYear, currentMonth, 1).getDay();
            const lastDateOfMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const lastDateOfPrevMonth = new Date(currentYear, currentMonth, 0).getDate();

            monthYearEl.textContent = `${new Date(currentYear, currentMonth).toLocaleString('id-ID', { month: 'long', year: 'numeric' })}`;

            for (let i = firstDayOfMonth; i > 0; i--) {
                calendarDatesEl.innerHTML += `<div class="p-2 h-14 text-center text-slate-400">${lastDateOfPrevMonth - i + 1}</div>`;
            }
            
            for (let i = 1; i <= lastDateOfMonth; i++) {
                const date = new Date(currentYear, currentMonth, i);
                const dateString = toYYYYMMDD(date);
                
                const today = new Date();
                const isToday = i === today.getDate() && currentMonth === today.getMonth() && currentYear === today.getFullYear();
                const isSelected = date.toDateString() === selectedDate.toDateString();

                let classes = 'calendar-day p-2 h-14 text-center cursor-pointer rounded-full relative flex flex-col items-center justify-center';

                if (isSelected) {
                    classes += ' bg-gradient-to-br from-blue-500 to-blue-600 text-white font-bold shadow-md';
                } else if (isToday) {
                    classes += ' bg-slate-200 text-slate-800 font-semibold';
                } else {
                    classes += ' hover:bg-blue-50'
                }

                const dotColor = getDotColorForDate(dateString);
                const eventDot = dotColor ? `<div class="event-dot ${dotColor} mt-1"></div>` : '';

                calendarDatesEl.innerHTML += `<div class="${classes}" data-date="${dateString}">${i}${eventDot}</div>`;
            }
            
            document.querySelectorAll('.calendar-day[data-date]').forEach(day => {
                day.addEventListener('click', (e) => {
                    selectedDate = fromYYYYMMDD(e.currentTarget.dataset.date);
                    renderCalendar();
                    showEventsForDate(selectedDate);
                });
            });
        }

        function showEventsForDate(date) {
            const selectedDateDisplayEl = document.getElementById('selected-date-display');
            const eventListEl = document.getElementById('event-list');
            const dateString = toYYYYMMDD(date);
            selectedDateDisplayEl.textContent = date.toLocaleDateString('id-ID', { day: 'numeric', month: 'long' });
            
            let filteredEvents = events.filter(event => event.date === dateString);

            if (currentFilter === 'done') {
                filteredEvents = filteredEvents.filter(event => event.status === true);
            } else if (currentFilter === 'not-done') {
                filteredEvents = filteredEvents.filter(event => event.status === false || event.status === undefined);
            }
            
            eventListEl.innerHTML = '';
            
            if (filteredEvents.length > 0) {
                filteredEvents.sort((a, b) => (a.time || "23:59").localeCompare(b.time || "23:59"));
                filteredEvents.forEach(event => {
                    const eventEl = document.createElement('div');
                    const isDone = event.status === true;
                    const category = event.category || 'default';
                    const catColor = categoryColors[category];
                    
                    eventEl.className = `p-3 rounded-lg border-l-4 ${catColor} flex items-start justify-between gap-4 ${isDone ? 'bg-slate-100' : 'bg-white shadow-sm'}`;

                    let eventDetailsHTML = '';
                    switch (category) {
                        case 'konten':
                            eventDetailsHTML = `
                                <p class="font-semibold text-slate-800">${escapeHtml(event.title)}</p>
                                ${event.link ? `<a href="${escapeAttr(event.link)}" target="_blank" rel="noopener noreferrer" class="text-sm text-blue-600 hover:underline break-all">Lihat Konten</a>` : ''}
                                ${event.note ? `<p class="text-sm text-slate-500 mt-1 whitespace-pre-wrap">${escapeHtml(event.note)}</p>` : ''}
                            `;
                            break;
                        case 'agenda':
                            eventDetailsHTML = `
                                <p class="font-semibold text-slate-800">${escapeHtml(event.title)}</p>
                                <p class="text-sm text-slate-500">${escapeHtml(event.time) || 'Sepanjang hari'}</p>
                            `;
                            break;
                        case 'flayer':
                            eventDetailsHTML = `<p class="font-semibold text-slate-800">${escapeHtml(event.title)}</p>`;
                            break;
                    }

                    eventEl.innerHTML = `
                        <div class="flex items-start gap-3 flex-grow">
                             <input type="checkbox" data-id="${event.id}" class="custom-checkbox status-checkbox mt-1" ${isDone ? 'checked' : ''}>
                            <div class="flex-grow ${isDone ? 'opacity-60 line-through' : ''}">
                                ${eventDetailsHTML}
                            </div>
                        </div>
                        <div class="flex items-center gap-1 flex-shrink-0">
                            <button data-event='${JSON.stringify(escapeEventData(event))}' class="edit-event-btn text-slate-400 hover:text-blue-600 p-1 rounded-full">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z"></path></svg>
                            </button>
                            <button data-id="${event.id}" class="delete-event-btn text-slate-400 hover:text-red-600 p-1 rounded-full">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    `;
                    eventListEl.appendChild(eventEl);
                });

                document.querySelectorAll('.edit-event-btn').forEach(btn => btn.addEventListener('click', openEditModal));
                document.querySelectorAll('.delete-event-btn').forEach(btn => btn.addEventListener('click', openDeleteModal));
                document.querySelectorAll('.status-checkbox').forEach(box => box.addEventListener('change', handleStatusChange));

            } else {
                eventListEl.innerHTML = `
                    <div class="text-center py-16 px-4">
                        <svg class="mx-auto h-12 w-12 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        <h3 class="mt-2 text-sm font-medium text-slate-900">Tidak ada jadwal</h3>
                        <p class="mt-1 text-sm text-slate-500">Belum ada jadwal untuk filter ini.</p>
                    </div>
                `;
            }
        }

        async function addEvent() {
            const category = document.getElementById('add-event-category').value;
            const data = {
                category: category,
                date: toYYYYMMDD(selectedDate),
                status: false,
                createdAt: serverTimestamp()
            };

            const titleEl = document.getElementById('add-event-title');
            if (!titleEl || !titleEl.value.trim()) {
                showNotification('Nama tidak boleh kosong!');
                return;
            }
            data.title = titleEl.value.trim();

            switch (category) {
                case 'konten':
                    data.link = document.getElementById('add-event-link').value.trim();
                    data.note = document.getElementById('add-event-note').value.trim();
                    break;
                case 'agenda':
                    data.time = document.getElementById('add-event-time').value;
                    break;
            }

            try {
                const eventCollection = collection(db, 'public_calendar');
                await addDoc(eventCollection, data);
                closeModal();
            } catch (error) {
                console.error("Error adding document: ", error);
                showNotification("Gagal menambahkan jadwal. Silakan coba lagi.");
            }
        }

        async function updateEvent() {
            const eventId = document.getElementById('edit-event-id').value;
            const category = document.getElementById('edit-event-category').value;
            const data = { category };
            
            const titleEl = document.getElementById('edit-event-title');
            if (!titleEl || !titleEl.value.trim()) {
                showNotification('Nama tidak boleh kosong!');
                return;
            }
            data.title = titleEl.value.trim();

            switch (category) {
                case 'konten':
                    data.link = document.getElementById('edit-event-link').value.trim();
                    data.note = document.getElementById('edit-event-note').value.trim();
                    data.time = null;
                    break;
                case 'agenda':
                    data.time = document.getElementById('edit-event-time').value;
                    data.link = null;
                    data.note = null;
                    break;
                case 'flayer':
                     data.time = null;
                     data.link = null;
                     data.note = null;
                    break;
            }

            try {
                const eventDocRef = doc(db, 'public_calendar', eventId);
                await updateDoc(eventDocRef, data);
                closeModal();
            } catch (error) {
                console.error("Error updating document: ", error);
                showNotification("Gagal memperbarui jadwal.");
            }
        }

        async function updateEventStatus(eventId, status) {
            try {
                const eventDocRef = doc(db, 'public_calendar', eventId);
                await updateDoc(eventDocRef, { status });
            } catch (error) {
                console.error("Error updating status: ", error);
                showNotification("Gagal memperbarui status.");
            }
        }

        async function deleteEvent(eventId) {
            try {
                const eventDocRef = doc(db, 'public_calendar', eventId);
                await deleteDoc(eventDocRef);
            } catch (error) {
                console.error("Error deleting document: ", error);
                showNotification("Gagal menghapus jadwal.");
            }
        }
        
        function listenForEvents() {
            if (unsubscribe) unsubscribe(); 
            const eventCollection = collection(db, 'public_calendar');
            const q = query(eventCollection);
            
            unsubscribe = onSnapshot(q, (querySnapshot) => {
                events = [];
                querySnapshot.forEach((doc) => {
                    events.push({ id: doc.id, ...doc.data() });
                });

                if (!notificationShown) {
                    const todayString = toYYYYMMDD(new Date());
                    const eventsForToday = events.filter(event => event.date === todayString);
                    if (eventsForToday.length > 0) {
                        showToast(`Anda memiliki ${eventsForToday.length} jadwal hari ini.`);
                        notificationShown = true;
                    }
                }

                renderCalendar();
                showEventsForDate(selectedDate);
            }, (error) => {
                console.error("Error listening to events: ", error);
                if (error.code === 'permission-denied') {
                    showNotification("Error: Izin Ditolak. Pastikan Aturan Keamanan (Security Rules) di Firebase sudah diatur untuk mengizinkan akses publik.");
                } else {
                    showNotification("Gagal memuat data jadwal. Periksa koneksi Anda.");
                }
            });
        }
        
        function closeModal() {
            const modalTemplate = document.getElementById('modal-template');
            modalTemplate.classList.add('hidden');
        }

        function openAddModal() {
            const modalTemplate = document.getElementById('modal-template');
            const modalContent = modalTemplate.querySelector('.modal-content');
            modalContent.innerHTML = `
                <h3 class="text-xl font-bold mb-4">Tambah Jadwal Baru</h3>
                <div class="space-y-3">
                    <div>
                        <label for="add-event-category" class="block text-sm font-medium text-slate-700 mb-1">Pilih Kategori</label>
                        <select id="add-event-category" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition bg-white">
                            <option value="konten">Konten</option>
                            <option value="agenda">Agenda</option>
                            <option value="flayer">Flayer (Hari Penting)</option>
                        </select>
                    </div>
                    <div id="dynamic-add-form-fields"></div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button id="cancel-add-btn" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300 transition-colors">Batal</button>
                    <button id="add-event-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">Tambah</button>
                </div>
            `;
            
            const categorySelect = document.getElementById('add-event-category');
            const dynamicFieldsContainer = document.getElementById('dynamic-add-form-fields');
            
            switchFormField(dynamicFieldsContainer, categorySelect.value, 'add-');
            categorySelect.addEventListener('change', (e) => switchFormField(dynamicFieldsContainer, e.target.value, 'add-'));

            document.getElementById('cancel-add-btn').addEventListener('click', closeModal);
            document.getElementById('add-event-btn').addEventListener('click', addEvent);
            modalTemplate.querySelector('.modal-backdrop').addEventListener('click', closeModal);
            
            modalTemplate.classList.remove('hidden');
        }

        function openEditModal(e) {
            const event = JSON.parse(e.currentTarget.dataset.event);
            const modalTemplate = document.getElementById('modal-template');
            const modalContent = modalTemplate.querySelector('.modal-content');

            modalContent.innerHTML = `
                <h3 class="text-xl font-bold mb-4">Edit Jadwal</h3>
                <div class="space-y-4">
                    <input type="hidden" id="edit-event-id" value="${event.id}">
                    <div>
                        <label for="edit-event-category" class="block text-sm font-medium text-slate-700 mb-1">Kategori</label>
                        <select id="edit-event-category" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition bg-white">
                            <option value="konten">Konten</option>
                            <option value="agenda">Agenda</option>
                            <option value="flayer">Flayer (Hari Penting)</option>
                        </select>
                    </div>
                    <div id="dynamic-edit-form-fields"></div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button id="cancel-edit-btn" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300 transition-colors">Batal</button>
                    <button id="save-edit-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">Simpan Perubahan</button>
                </div>
            `;

            const categorySelect = document.getElementById('edit-event-category');
            const dynamicFieldsContainer = document.getElementById('dynamic-edit-form-fields');
            categorySelect.value = event.category || 'konten';
            
            switchFormField(dynamicFieldsContainer, categorySelect.value, 'edit-');
            
            document.getElementById('edit-event-title').value = event.title || '';
            switch (event.category) {
                case 'konten':
                    document.getElementById('edit-event-link').value = event.link || '';
                    document.getElementById('edit-event-note').value = event.note || '';
                    break;
                case 'agenda':
                    document.getElementById('edit-event-time').value = event.time || '';
                    break;
            }

            categorySelect.addEventListener('change', (e) => switchFormField(dynamicFieldsContainer, e.target.value, 'edit-'));
            document.getElementById('cancel-edit-btn').addEventListener('click', closeModal);
            document.getElementById('save-edit-btn').addEventListener('click', updateEvent);
            modalTemplate.querySelector('.modal-backdrop').addEventListener('click', closeModal);
            
            modalTemplate.classList.remove('hidden');
        }

        function openDeleteModal(e) {
            const eventId = e.currentTarget.dataset.id;
            const modalContent = modalTemplate.querySelector('.modal-content');
            modalContent.innerHTML = `
                <h3 class="text-lg font-medium text-slate-900 text-center">Hapus Jadwal?</h3>
                <p class="mt-2 text-sm text-slate-500 text-center">Apakah Anda yakin ingin menghapus jadwal ini? Tindakan ini tidak dapat diurungkan.</p>
                <div class="mt-6 flex justify-center gap-3">
                    <button id="cancel-delete-btn" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300 transition-colors">Batal</button>
                    <button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">Ya, Hapus</button>
                </div>
            `;
            document.getElementById('cancel-delete-btn').addEventListener('click', closeModal);
            document.getElementById('confirm-delete-btn').addEventListener('click', async () => {
                await deleteEvent(eventId);
                closeModal();
            });
            modalTemplate.querySelector('.modal-backdrop').addEventListener('click', closeModal);
            modalTemplate.classList.remove('hidden');
        }

        function showNotification(message) {
            const modalContent = modalTemplate.querySelector('.modal-content');
            modalContent.innerHTML = `
                <p class="text-slate-800 text-center">${message}</p>
                <div class="mt-6 flex justify-center gap-3">
                    <button id="notification-ok-btn" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">Oke</button>
                </div>
            `;
            document.getElementById('notification-ok-btn').addEventListener('click', closeModal);
            modalTemplate.querySelector('.modal-backdrop').addEventListener('click', closeModal);
            modalTemplate.classList.remove('hidden');
        }

        function showToast(message) {
            const toast = document.getElementById('toast-notification');
            const toastMessage = document.getElementById('toast-message');
            const closeToastBtn = document.getElementById('close-toast');

            toastMessage.textContent = message;
            toast.classList.remove('translate-y-20', 'opacity-0');
            toast.classList.add('translate-y-0', 'opacity-100');

            const hideToast = () => {
                toast.classList.remove('translate-y-0', 'opacity-100');
                toast.classList.add('translate-y-20', 'opacity-0');
            };

            closeToastBtn.onclick = hideToast;

            setTimeout(hideToast, 5000); // Hide after 5 seconds
        }

        function handleStatusChange(e) {
            const eventId = e.target.dataset.id;
            const isDone = e.target.checked;
            updateEventStatus(eventId, isDone);
        }

        function escapeAttr(str) {
            if (typeof str !== 'string') return '';
            return str.replace(/"/g, '&quot;');
        }
        function escapeHtml(str) {
            if (typeof str !== 'string') return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
        }
        function escapeEventData(event) {
            const newEvent = {};
            for (const key in event) {
                if (typeof event[key] === 'string') {
                    newEvent[key] = escapeHtml(event[key]);
                } else {
                    newEvent[key] = event[key];
                }
            }
            return newEvent;
        }

        function toYYYYMMDD(date) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }
        
        function fromYYYYMMDD(str) {
            const parts = str.split('-');
            return new Date(parts[0], parts[1] - 1, parts[2]);
        }

        function updateFilterButtons(activeFilter) {
            const filterAllBtn = document.getElementById('filter-all');
            const filterDoneBtn = document.getElementById('filter-done');
            const filterNotDoneBtn = document.getElementById('filter-not-done');
            [filterAllBtn, filterDoneBtn, filterNotDoneBtn].forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`filter-${activeFilter.replace('_','-')}`).classList.add('active');
        }
        
        // --- EVENT LISTENERS ---
        window.onload = () => {
            const openAddModalBtn = document.getElementById('open-add-modal-btn');
            const prevMonthBtn = document.getElementById('prev-month');
            const nextMonthBtn = document.getElementById('next-month');
            const filterAllBtn = document.getElementById('filter-all');
            const filterDoneBtn = document.getElementById('filter-done');
            const filterNotDoneBtn = document.getElementById('filter-not-done');
            
            openAddModalBtn.addEventListener('click', openAddModal);

            prevMonthBtn.addEventListener('click', () => {
                currentMonth--;
                if (currentMonth < 0) { currentMonth = 11; currentYear--; }
                renderCalendar();
            });

            nextMonthBtn.addEventListener('click', () => {
                currentMonth++;
                if (currentMonth > 11) { currentMonth = 0; currentYear++; }
                renderCalendar();
            });

            filterAllBtn.addEventListener('click', () => {
                currentFilter = 'all';
                updateFilterButtons('all');
                showEventsForDate(selectedDate);
            });
            filterDoneBtn.addEventListener('click', () => {
                currentFilter = 'done';
                updateFilterButtons('done');
                showEventsForDate(selectedDate);
            });
            filterNotDoneBtn.addEventListener('click', () => {
                currentFilter = 'not-done';
                updateFilterButtons('not-done');
                showEventsForDate(selectedDate);
            });

            listenForEvents();
            renderCalendar();
            showEventsForDate(selectedDate);
        };

    </script>
</body>
</html>
